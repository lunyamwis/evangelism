
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üè• SDA Medical Missionary Module</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* === RESET & BASE === */
  *, *::before, *::after { box-sizing: border-box; margin:0; padding:0;}
  html, body {
    height: 100%;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #e0f0f0, #a5d8d8);
    color: #10454d;
    scroll-behavior: smooth;
  }
  body, button, input, select, textarea {
    font-size: 1rem;
    font-weight: 600;
  }
  button {
    cursor: pointer;
    user-select: none;
    border: none;
    background: #10797a;
    color: white;
    border-radius: 10px;
    padding: 0.55rem 1.35rem;
    transition: background-color 0.25s ease, box-shadow 0.25s ease;
  }
  button:hover, button:focus {
    background-color: #0c5959;
    box-shadow: 0 0 12px #0c595999;
    outline: none;
  }
  a {
    color: #10797a;
    text-decoration: none;
    transition: text-decoration 0.3s ease;
  }
  a:hover, a:focus {
    text-decoration: underline;
  }
  h1,h2,h3,h4,h5,h6 {
    font-weight: 900;
  }
  label, p {
    line-height: 1.4;
  }
  /* Scrollbars */
  ::-webkit-scrollbar {
    width: 14px;
    height: 14px;
  }
  ::-webkit-scrollbar-thumb {
    background-color: #58a5a6cc;
    border-radius: 14px;
    border: 4px solid #cbe6e6;
  }
  ::-webkit-scrollbar-thumb:hover {
    background-color: #1f727273;
  }
  ::-webkit-scrollbar-track {
    background-color: #d6f0f0;
  }

  /* Layout grid */
  body {
    display: grid;
    grid-template-columns: 220px 1fr 360px;
    grid-template-rows: 64px 1fr 100px;
    grid-template-areas:
      "sidebar header header"
      "sidebar main assistant"
      "sidebar footer footer";
    height: 100vh;
    gap: 8px;
  }

  nav#sidebar {
    grid-area: sidebar;
    background-color: #0b4f50;
    color: #cde7e7;
    display: flex;
    flex-direction: column;
    padding: 1rem 12px;
    box-shadow: inset 4px 0 15px rgba(0,0,0,0.3);
  }
  nav#sidebar button {
    background: transparent;
    color: #a1cfcf;
    border: none;
    padding: 14px 10px;
    font-weight: 700;
    font-size: 1.05rem;
    cursor: pointer;
    user-select: none;
    text-align: left;
    margin-bottom: 8px;
    border-radius: 10px;
    transition: background-color 0.3s ease;
  }
  nav#sidebar button:hover,
  nav#sidebar button:focus,
  nav#sidebar button.active {
    background-color: #149494;
    color: white;
    outline: none;
  }

  header#header {
    grid-area: header;
    background: linear-gradient(90deg, #0a6868, #064747);
    color: white;
    font-weight: 900;
    font-size: 1.45rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 2rem;
    user-select: none;
    box-shadow: 0 0 20px #0a3a3aaa;
  }
  header#header button {
    background: #b44343;
    padding: 0.5rem 1rem;
    border-radius: 10px;
    font-weight: 800;
  }
  header#header button:hover {
    background: #801a1a;
  }

  footer#footer {
    grid-area: footer;
    background-color: #0c706fcc;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
  }

  main#main {
    grid-area: main;
    background: white;
    border-radius: 24px;
    padding: 2rem 3rem;
    overflow-y: auto;
    box-shadow: inset 0 0 12px #81b3b3aa;
    display: flex;
    flex-direction: column;
  }

  aside#assistant {
    grid-area: assistant;
    background: #dbf0f0cc;
    border-left: 3px solid #0a8e8d;
    padding: 1rem 1.5rem;
    font-family: monospace;
    font-weight: 600;
    display: flex;
    flex-direction: column;
  }
  #assistantHeader {
    font-weight: 700;
    font-size: 1.28rem;
    color: #0a4746;
    margin-bottom: 1rem;
    user-select: none;
  }
  #chatWindow {
    flex-grow: 1;
    background: white;
    border-radius: 16px;
    border: 2px solid #7eb7b7;
    overflow-y: auto;
    padding: 14px 18px;
    font-size: 0.9rem;
    color: #0a4746;
  }
  .chat-message {
    max-width: 80%;
    line-height: 1.3;
    margin-bottom: 14px;
    padding: 9px 14px;
    border-radius: 24px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .chat-message.user {
    background: #a3d9d9cc;
    color: #094d4d;
    align-self: flex-end;
  }
  .chat-message.ai {
    background: #b9f0f0cc;
    color: #094d4d;
    align-self: flex-start;
  }
  #inputArea {
    margin-top: 12px;
    display: flex;
    gap: 0.5rem;
  }
  #userInput {
    flex-grow: 1;
    border-radius: 24px;
    border: 2px solid #0a8e8d;
    padding: 0.5rem 1rem;
    font-family: inherit;
    font-weight: 600;
    font-size: 1rem;
  }
  #sendBtn, #voiceToggleBtn {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: #0a8e8d;
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    transition: background-color 0.3s ease;
  }
  #sendBtn:hover, #voiceToggleBtn:hover,
  #sendBtn:focus, #voiceToggleBtn:focus {
    background-color: #065453;
    outline: none;
  }

  section.module {
    margin-bottom: 28px;
  }
  h3 {
    font-weight: 900;
    margin-bottom: 12px;
    user-select: none;
  }
  label {
    margin-top: 14px;
    display: block;
    font-weight: 700;
  }
  input[type="text"], input[type="date"], input[type="time"], select, textarea {
    width: 100%;
    padding: 10px 14px;
    border-radius: 14px;
    border: 2px solid #7cbebe;
    font-weight: 600;
    font-family: inherit;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, select:focus, textarea:focus {
    border-color: #0a8e8d;
    box-shadow: 0 0 12px #0a8e8da8;
    outline: none;
  }
  textarea {
    resize: vertical;
    min-height: 90px;
    font-style: italic;
  }
  button.btn-primary {
    margin-top: 18px;
    padding: 0.7rem 1.6rem;
    border-radius: 18px;
  }
  table {
    font-family: monospace;
    border-collapse: collapse;
    width: 100%;
    margin-top: 16px;
  }
  th, td {
    border: 1.3px solid #7cbebe;
    padding: 0.65rem 1rem;
    text-align: left;
  }
  th {
    background-color: #add7d9;
    color: #065353;
  }
  tbody tr:nth-child(even) {
    background-color: #d5ededcc;
  }
  tbody tr:hover {
    background-color: #cce4e6cc;
    cursor: pointer;
  }
</style>
</head>
<body>

<nav id="sidebar" aria-label="Main Navigation" tabindex="0" aria-live="polite">
  <button class="tab-btn active" id="tab-clinic-schedule" aria-selected="true" role="tab" aria-controls="panel-clinic-schedule">üìÖ Clinic Scheduling</button>
  <button class="tab-btn" id="tab-patient-intake" aria-selected="false" role="tab" aria-controls="panel-patient-intake">üë®‚Äç‚öïÔ∏è Patient Intake</button>
  <button class="tab-btn" id="tab-volunteers" aria-selected="false" role="tab" aria-controls="panel-volunteers">üë©‚Äç‚öïÔ∏è Volunteers</button>
  <button class="tab-btn" id="tab-treatments" aria-selected="false" role="tab" aria-controls="panel-treatments">üíä Treatments</button>
  <button class="tab-btn" id="tab-inventory" aria-selected="false" role="tab" aria-controls="panel-inventory">üî¨ Inventory</button>
  <button class="tab-btn" id="tab-education" aria-selected="false" role="tab" aria-controls="panel-education">üìñ Health Education</button>
  <button class="tab-btn" id="tab-reports" aria-selected="false" role="tab" aria-controls="panel-reports">üìà Reports</button>
</nav>

<header id="header" aria-label="Application Header">
  SDA Medical Missionary Module
  <button id="btnReset" aria-label="Reset All Data" title="Reset All Data">Reset App</button>
</header>

<main id="main" role="main" tabindex="0">

  <!-- Clinic Scheduling -->
  <section id="panel-clinic-schedule" class="module panel active" role="tabpanel" tabindex="0" aria-labelledby="tab-clinic-schedule" aria-hidden="false">
    <h2>Clinic & Outreach Scheduling</h2>
    <form id="formClinicSchedule">
      <label for="clinicDate">Date</label>
      <input type="date" id="clinicDate" required />
      <label for="clinicTime">Time</label>
      <input type="time" id="clinicTime" required />
      <label for="clinicLocation">Location</label>
      <input type="text" id="clinicLocation" placeholder="Address or venue" required />
      <label for="clinicNotes">Notes</label>
      <textarea id="clinicNotes" placeholder="Optional notes"></textarea>
      <button type="submit" class="btn-primary" aria-label="Add Clinic Schedule">Add Schedule</button>
    </form>
    <h3>Upcoming Clinic Sessions</h3>
    <table id="clinicScheduleTable" aria-live="polite" aria-label="Clinic scheduling table">
      <thead><tr><th>Date</th><th>Time</th><th>Location</th><th>Notes</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Patient Intake -->
  <section id="panel-patient-intake" class="module panel" role="tabpanel" tabindex="0" aria-labelledby="tab-patient-intake" aria-hidden="true" hidden>
    <h2>Patient Intake & Health History</h2>
    <form id="formPatientIntake">
      <label for="patientName">Full Name</label>
      <input type="text" id="patientName" required placeholder="Patient full name" />
      <label for="patientDOB">Date of Birth</label>
      <input type="date" id="patientDOB" required />
      <label for="patientAddress">Address</label>
      <input type="text" id="patientAddress" placeholder="Optional address"/>
      <label for="patientSDAHealth">SDA Health Message Adherence</label>
      <select id="patientSDAHealth"><option value="">Select</option><option>Yes</option><option>No</option></select>
      <label for="patientHistory">Medical History</label>
      <textarea id="patientHistory" placeholder="Known conditions & medical history"></textarea>
      <button type="submit" class="btn-primary" aria-label="Add Patient">Add Patient</button>
    </form>
    <h3>Registered Patients</h3>
    <table id="patientIntakeTable" aria-live="polite" aria-label="Patient intake table">
      <thead><tr><th>Name</th><th>DOB</th><th>Address</th><th>SDA Health</th><th>History</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Volunteers -->
  <section id="panel-volunteers" class="module panel" role="tabpanel" tabindex="0" aria-labelledby="tab-volunteers" aria-hidden="true" hidden>
    <h2>Volunteer Medical Staff Management</h2>
    <form id="formVolunteers">
      <label for="volunteerName">Name</label>
      <input type="text" id="volunteerName" placeholder="Full name" required />
      <label for="volunteerRole">Role</label>
      <input type="text" id="volunteerRole" placeholder="Doctor, Nurse, Admin" required />
      <label for="volunteerContact">Contact info</label>
      <input type="text" id="volunteerContact" placeholder="Phone/email"/>
      <button type="submit" class="btn-primary" aria-label="Add Volunteer">Add Volunteer</button>
    </form>
    <h3>Current Volunteers</h3>
    <table id="volunteersTable" aria-live="polite" aria-label="Volunteers table">
      <thead><tr><th>Name</th><th>Role</th><th>Contact</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Treatments -->
  <section id="panel-treatments" class="module panel" role="tabpanel" tabindex="0" aria-labelledby="tab-treatments" aria-hidden="true" hidden>
    <h2>Patient Treatments & Prescriptions</h2>
    <form id="formTreatments">
      <label for="treatmentPatient">Patient Name</label>
      <input type="text" id="treatmentPatient" placeholder="Patient full name" required />
      <label for="treatmentCondition">Condition Diagnosed</label>
      <input type="text" id="treatmentCondition" placeholder="E.g. Hypertension" required />
      <label for="treatmentPrescription">Prescription Details</label>
      <textarea id="treatmentPrescription" placeholder="Medicines & instructions" required></textarea>
      <button type="submit" class="btn-primary" aria-label="Add Treatment Record">Add Treatment</button>
    </form>
    <h3>Treatment Records</h3>
    <table id="treatmentsTable" aria-live="polite" aria-label="Treatment records table">
      <thead><tr><th>Patient</th><th>Condition</th><th>Prescription</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Inventory -->
  <section id="panel-inventory" class="module panel" role="tabpanel" tabindex="0" aria-labelledby="tab-inventory" aria-hidden="true" hidden>
    <h2>Medicine & Supplies Inventory</h2>
    <form id="formInventory">
      <label for="medicineName">Medicine Name</label>
      <input type="text" id="medicineName" placeholder="Name of medicine or supply" required />
      <label for="medicineQuantity">Quantity in Stock</label>
      <input type="number" id="medicineQuantity" min="0" placeholder="Number of units" required />
      <label for="medicineReorderLevel">Reorder Level</label>
      <input type="number" id="medicineReorderLevel" min="0" placeholder="When to reorder" required />
      <button type="submit" class="btn-primary" aria-label="Add Inventory Item">Add Inventory</button>
    </form>
    <h3>Inventory Items</h3>
    <table id="inventoryTable" aria-live="polite" aria-label="Inventory table">
      <thead><tr><th>Name</th><th>Quantity</th><th>Reorder Level</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Education -->
  <section id="panel-education" class="module panel" role="tabpanel" tabindex="0" aria-labelledby="tab-education" aria-hidden="true" hidden>
    <h2>Health Education Materials</h2>
    <form id="formEducation">
      <label for="educationTitle">Title</label>
      <input type="text" id="educationTitle" placeholder="Material title" required />
      <label for="educationDescription">Description</label>
      <textarea id="educationDescription" placeholder="Brief summary"></textarea>
      <label for="educationLink">Resource Link (optional)</label>
      <input type="url" id="educationLink" placeholder="https://example.com" />
      <button type="submit" class="btn-primary" aria-label="Add Education Material">Add Material</button>
    </form>
    <h3>Available Materials</h3>
    <table id="educationTable" aria-live="polite" aria-label="Education materials table">
      <thead><tr><th>Title</th><th>Description</th><th>Link</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Reports -->
  <section id="panel-reports" class="module panel" role="tabpanel" tabindex="0" aria-labelledby="tab-reports" aria-hidden="true" hidden>
    <h2>Reports & Analytics</h2>
    <canvas id="patientsChart" aria-label="Patient Intake Over Time" role="img" width="700" height="350"></canvas>
    <canvas id="inventoryChart" aria-label="Inventory Stock Levels" role="img" width="700" height="350" style="margin-top: 24px;"></canvas>
  </section>

</main>

<aside id="assistant" role="complementary" aria-label="AI assistant" tabindex="0">
  <div id="assistantHeader" tabindex="0" aria-live="polite" aria-atomic="true">ü§ñ AI Assistant</div>
  <div id="chatWindow" role="log" aria-live="polite" aria-atomic="false" aria-relevant="additions" tabindex="0" aria-label="Chat conversation"></div>
  <div id="inputArea">
    <input type="text" id="userInput" aria-label="Type your message to assistant" placeholder="Ask about medical missions..." autocomplete="off" spellcheck="false" />
    <button id="sendBtn" aria-label="Send message to assistant">‚û§</button>
    <button id="voiceToggleBtn" aria-label="Toggle voice input">üéôÔ∏è</button>
  </div>
</aside>

<footer id="footer" role="contentinfo">
  ¬© 2025 SDA Medical Missionary Module
</footer>

<script>
(() => {
  // --- DOM refs and state ---
  const tabs = [...document.querySelectorAll('#sidebar button.tab-btn')];
  const panels = [...document.querySelectorAll('main#main section.module.panel')];
  const btnReset = document.getElementById('btnReset');

  // Clinic scheduling
  const formClinicSchedule = document.getElementById('formClinicSchedule');
  const clinicScheduleTableBody = document.querySelector('#clinicScheduleTable tbody');
  let clinicSchedules = [];

  // Patient intake
  const formPatientIntake = document.getElementById('formPatientIntake');
  const patientIntakeTableBody = document.querySelector('#patientIntakeTable tbody');
  let patients = [];

  // Volunteers
  const formVolunteers = document.getElementById('formVolunteers');
  const volunteersTableBody = document.querySelector('#volunteersTable tbody');
  let volunteers = [];

  // Treatments
  const formTreatments = document.getElementById('formTreatments');
  const treatmentsTableBody = document.querySelector('#treatmentsTable tbody');
  let treatments = [];

  // Inventory
  const formInventory = document.getElementById('formInventory');
  const inventoryTableBody = document.querySelector('#inventoryTable tbody');
  let inventory = [];

  // Education
  const formEducation = document.getElementById('formEducation');
  const educationTableBody = document.querySelector('#educationTable tbody');
  let educationMaterials = [];

  // Reports charts
  const patientsChartCtx = document.getElementById('patientsChart').getContext('2d');
  const inventoryChartCtx = document.getElementById('inventoryChart').getContext('2d');
  let patientsChartInstance, inventoryChartInstance;

  // AI assistant
  const chatWindow = document.getElementById('chatWindow');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const voiceToggleBtn = document.getElementById('voiceToggleBtn');
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  let recognizer = null;
  let voiceActive = false;

  // Utility functions
  function sanitize(text) {
    return String(text).replace(/[&<>"']/g, c => ({
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
    })[c]);
  }
  function generateId() {
    return 'id_' + Math.random().toString(36).slice(2, 10);
  }

  // Persistence helpers
  function saveData() {
    localStorage.setItem('mdm-clinicSchedules', JSON.stringify(clinicSchedules));
    localStorage.setItem('mdm-patients', JSON.stringify(patients));
    localStorage.setItem('mdm-volunteers', JSON.stringify(volunteers));
    localStorage.setItem('mdm-treatments', JSON.stringify(treatments));
    localStorage.setItem('mdm-inventory', JSON.stringify(inventory));
    localStorage.setItem('mdm-education', JSON.stringify(educationMaterials));
  }
  function loadData() {
    clinicSchedules = JSON.parse(localStorage.getItem('mdm-clinicSchedules')) || [];
    patients = JSON.parse(localStorage.getItem('mdm-patients')) || [];
    volunteers = JSON.parse(localStorage.getItem('mdm-volunteers')) || [];
    treatments = JSON.parse(localStorage.getItem('mdm-treatments')) || [];
    inventory = JSON.parse(localStorage.getItem('mdm-inventory')) || [];
    educationMaterials = JSON.parse(localStorage.getItem('mdm-education')) || [];
  }

  // Render helpers for each module
  function renderClinicSchedules() {
    clinicScheduleTableBody.innerHTML = '';
    if (clinicSchedules.length === 0) {
      clinicScheduleTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No clinic sessions scheduled.</td></tr>`;
      return;
    }
    clinicSchedules.sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
    clinicSchedules.forEach(item => {
      clinicScheduleTableBody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${sanitize(item.date)}</td>
        <td>${sanitize(item.time)}</td>
        <td>${sanitize(item.location)}</td>
        <td>${sanitize(item.notes)}</td>
        <td><button data-id="${item.id}" class="btn-delete">Delete</button></td>
      </tr>`);
    });
  }
  function renderPatients() {
    patientIntakeTableBody.innerHTML = '';
    if (patients.length === 0) {
      patientIntakeTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No patients registered.</td></tr>`;
      return;
    }
    patients.forEach(p => {
      patientIntakeTableBody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${sanitize(p.name)}</td>
        <td>${sanitize(p.dob)}</td>
        <td>${sanitize(p.address || '')}</td>
        <td>${sanitize(p.sdaHealth || '')}</td>
        <td>${sanitize(p.history || '')}</td>
        <td><button data-id="${p.id}" class="btn-delete">Delete</button></td>
      </tr>`);
    });
  }
  function renderVolunteers() {
    volunteersTableBody.innerHTML = '';
    if (volunteers.length === 0) {
      volunteersTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">No volunteers added.</td></tr>`;
      return;
    }
    volunteers.forEach(v => {
      volunteersTableBody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${sanitize(v.name)}</td>
        <td>${sanitize(v.role)}</td>
        <td>${sanitize(v.contact || '')}</td>
        <td><button data-id="${v.id}" class="btn-delete">Delete</button></td>
      </tr>`);
    });
  }
  function renderTreatments() {
    treatmentsTableBody.innerHTML = '';
    if (treatments.length === 0) {
      treatmentsTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">No treatments recorded.</td></tr>`;
      return;
    }
    treatments.forEach(t => {
      treatmentsTableBody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${sanitize(t.patient)}</td>
        <td>${sanitize(t.condition)}</td>
        <td>${sanitize(t.prescription)}</td>
        <td><button data-id="${t.id}" class="btn-delete">Delete</button></td>
      </tr>`);
    });
  }
  function renderInventory() {
    inventoryTableBody.innerHTML = '';
    if (inventory.length === 0) {
      inventoryTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">No inventory items.</td></tr>`;
      return;
    }
    inventory.forEach(item => {
      const lowStock = item.quantity <= item.reorderLevel;
      inventoryTableBody.insertAdjacentHTML('beforeend', `
      <tr${lowStock ? ' style="background:#ffe6e6"' : ''}>
        <td>${sanitize(item.name)}</td>
        <td>${sanitize(item.quantity)}</td>
        <td>${sanitize(item.reorderLevel)}</td>
        <td><button data-id="${item.id}" class="btn-delete">Delete</button></td>
      </tr>`);
    });
  }
  function renderEducation() {
    educationTableBody.innerHTML = '';
    if (educationMaterials.length === 0) {
      educationTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">No education materials added.</td></tr>`;
      return;
    }
    educationMaterials.forEach(m => {
      educationTableBody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${sanitize(m.title)}</td>
        <td>${sanitize(m.description || '')}</td>
        <td>${m.link ? `<a href="${sanitize(m.link)}" target="_blank" rel="noopener">Link</a>` : ''}</td>
        <td><button data-id="${m.id}" class="btn-delete">Delete</button></td>
      </tr>`);
    });
  }

  // Render reports charts
  function renderReports() {
    const months = [];
    const patientsCount = [];
    const inventoryQuantities = [];

    const now = new Date();
    for(let i=5; i>=0; i--) {
      const dt = new Date(now.getFullYear(), now.getMonth() - i, 1);
      months.push(dt.toLocaleString('default', {month: 'short', year: 'numeric'}));

      const monthPrefix = dt.toISOString().slice(0,7);
      const count = patients.filter(p => p.dob && p.dob.startsWith(monthPrefix)).length;
      patientsCount.push(count);

      const inventorySum = inventory.reduce((acc, cur) => acc + cur.quantity, 0);
      inventoryQuantities.push(inventorySum);
    }

    if(patientsChartInstance) patientsChartInstance.destroy();
    if(inventoryChartInstance) inventoryChartInstance.destroy();

    patientsChartInstance = new Chart(patientsChartCtx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: "Patients Registered",
          data: patientsCount,
          borderColor: '#10797a',
          backgroundColor: 'rgba(16,121,122,0.4)',
          fill: true,
          tension: 0.25,
          pointRadius: 5,
        }]
      },
      options: {
        responsive: true,
        scales: {y: { beginAtZero: true }},
      }
    });

    inventoryChartInstance = new Chart(inventoryChartCtx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [{
          label: "Inventory Units Total",
          data: inventoryQuantities,
          backgroundColor: '#0a6f6e',
          borderColor: '#064c4b',
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        scales: {y: { beginAtZero: true }},
      }
    });
  }

  // Event handlers for forms and deletes
  // Clinic Schedule
  formClinicSchedule.addEventListener('submit', e => {
    e.preventDefault();
    const date = formClinicSchedule.clinicDate.value;
    const time = formClinicSchedule.clinicTime.value;
    const location = formClinicSchedule.clinicLocation.value.trim();
    const notes = formClinicSchedule.clinicNotes.value.trim();

    if(!date || !time || !location) return alert('Date, time, and location are required.');

    clinicSchedules.push({ id: generateId(), date, time, location, notes });
    saveData();
    formClinicSchedule.reset();
    renderClinicSchedules();
  });
  clinicScheduleTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('btn-delete')) {
      const id = e.target.dataset.id;
      clinicSchedules = clinicSchedules.filter(s => s.id !== id);
      saveData();
      renderClinicSchedules();
    }
  });

  // Patient Intake
  formPatientIntake.addEventListener('submit', e => {
    e.preventDefault();
    const name = formPatientIntake.patientName.value.trim();
    const dob = formPatientIntake.patientDOB.value;
    if(!name || !dob) return alert('Name and date of birth required.');
    const address = formPatientIntake.patientAddress.value.trim();
    const sdaHealth = formPatientIntake.patientSDAHealth.value;
    const history = formPatientIntake.patientHistory.value.trim();

    patients.push({ id: generateId(), name, dob, address, sdaHealth, history });
    saveData();
    formPatientIntake.reset();
    renderPatients();
  });
  patientIntakeTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('btn-delete')) {
      const id = e.target.dataset.id;
      patients = patients.filter(p => p.id !== id);
      saveData();
      renderPatients();
    }
  });

  // Volunteers
  formVolunteers.addEventListener('submit', e => {
    e.preventDefault();
    const name = formVolunteers.volunteerName.value.trim();
    const role = formVolunteers.volunteerRole.value.trim();
    if(!name || !role) return alert('Name and role required.');
    const contact = formVolunteers.volunteerContact.value.trim();

    volunteers.push({ id: generateId(), name, role, contact });
    saveData();
    formVolunteers.reset();
    renderVolunteers();
  });
  volunteersTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('btn-delete')) {
      const id = e.target.dataset.id;
      volunteers = volunteers.filter(v => v.id !== id);
      saveData();
      renderVolunteers();
    }
  });

  // Treatments
  formTreatments.addEventListener('submit', e => {
    e.preventDefault();
    const patient = formTreatments.treatmentPatient.value.trim();
    const condition = formTreatments.treatmentCondition.value.trim();
    const prescription = formTreatments.treatmentPrescription.value.trim();

    if(!patient || !condition || !prescription) return alert('All fields are required.');

    treatments.push({ id: generateId(), patient, condition, prescription });
    saveData();
    formTreatments.reset();
    renderTreatments();
  });
  treatmentsTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('btn-delete')) {
      const id = e.target.dataset.id;
      treatments = treatments.filter(t => t.id !== id);
      saveData();
      renderTreatments();
    }
  });

  // Inventory
  formInventory.addEventListener('submit', e => {
    e.preventDefault();
    const name = formInventory.medicineName.value.trim();
    const quantity = parseInt(formInventory.medicineQuantity.value);
    const reorderLevel = parseInt(formInventory.medicineReorderLevel.value);
    if(!name || isNaN(quantity) || isNaN(reorderLevel)) return alert('Fill all fields properly.');
    inventory.push({ id: generateId(), name, quantity, reorderLevel });
    saveData();
    formInventory.reset();
    renderInventory();
  });
  inventoryTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('btn-delete')) {
      const id = e.target.dataset.id;
      inventory = inventory.filter(i => i.id !== id);
      saveData();
      renderInventory();
    }
  });

  // Education materials
  formEducation.addEventListener('submit', e => {
    e.preventDefault();
    const title = formEducation.educationTitle.value.trim();
    if(!title) return alert('Title is required.');
    const description = formEducation.educationDescription.value.trim();
    const link = formEducation.educationLink.value.trim();
    educationMaterials.push({ id: generateId(), title, description, link });
    saveData();
    formEducation.reset();
    renderEducation();
  });
  educationTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('btn-delete')) {
      const id = e.target.dataset.id;
      educationMaterials = educationMaterials.filter(m => m.id !== id);
      saveData();
      renderEducation();
    }
  });

  // Tabs switch
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const targetId = tab.id.replace('tab-', 'panel-');
      panels.forEach(panel => {
        if(panel.id === targetId){
          panel.classList.add('active');
          panel.hidden = false;
          panel.focus();
          if(targetId === 'panel-reports'){
            renderReports();
          }
        } else {
          panel.classList.remove('active');
          panel.hidden = true;
        }
      });
    });
  });

  // Reset button
  btnReset.addEventListener('click', () => {
    if(confirm('Reset all medical missionary data? This action cannot be undone.')) {
      localStorage.clear();
      location.reload();
    }
  });

  // AI Assistant code (simple simulated responses)
  sendBtn.addEventListener('click', sendAIMessage);
  userInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendAIMessage();
    }
  });

  if(SpeechRecognition){
    recognizer = new SpeechRecognition();
    recognizer.lang = 'en-US';
    recognizer.continuous = false;
    recognizer.interimResults = false;
    recognizer.addEventListener('result', e => {
      const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
      userInput.value = transcript;
      userInput.focus();
    });
    recognizer.addEventListener('end', () => {
      if(voiceActive) recognizer.start();
    });
  } else {
    voiceToggleBtn.disabled = true;
    voiceToggleBtn.title = 'Speech Recognition not supported';
  }

  voiceToggleBtn.addEventListener('click', () => {
    if(!recognizer) return;
    if(voiceActive){
      recognizer.stop();
      voiceActive = false;
      voiceToggleBtn.textContent = 'üéôÔ∏è';
    } else {
      recognizer.start();
      voiceActive = true;
      voiceToggleBtn.textContent = 'üõë';
    }
  });

  function sendAIMessage(){
    const txt = userInput.value.trim();
    if(!txt) return;
    appendChat('user', txt);
    userInput.value = '';
    aiResponse(txt);
  }
  function appendChat(sender, message){
    const div = document.createElement('div');
    div.className = 'chat-message ' + sender;
    div.textContent = message;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  async function aiResponse(input){
    appendChat('ai', '...');
    await new Promise(r => setTimeout(r, 1000));
    chatWindow.querySelector('.chat-message.ai:last-child').remove();

    const low = input.toLowerCase();
    let reply = "I'm your SDA Medical Missionary assistant. Ask me about scheduling, patients, treatments, or inventory.";

    if(low.includes('schedule')) reply = "Use the Clinic Scheduling tab to set up outreach sessions.";
    else if(low.includes('patient')) reply = "Patient intake and health history can be managed under Patient Intake.";
    else if(low.includes('volunteer')) reply = "Manage volunteer medical staff in the Volunteers section.";
    else if(low.includes('treatment')) reply = "Add and track treatments given on the Treatments tab.";
    else if(low.includes('inventory')) reply = "Manage medicines and supplies in Inventory.";
    else if(low.includes('education')) reply = "Health education materials are available under Education.";
    else if(low.includes('report')) reply = "View visual reports in the Reports tab.";
    else if(low.includes('reset')) reply = "Use the red Reset button at top right to clear all data.";
    else if(low.includes('help')) reply = "I can guide you through medical missionary workflow. Ask me anything!";

    appendChat('ai', reply);
    speak(reply);
  }
  function speak(text){
    if(!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 1;
    try {
      speechSynthesis.speak(utterance);
    } catch {}
  }

  // Initial load
  loadData();
  renderClinicSchedules();
  renderPatients();
  renderVolunteers();
  renderTreatments();
  renderInventory();
  renderEducation();

})();
</script>

</body>
</html>
